<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="description" content="this is a blog"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Python多线程模块threading源码 · gzmviavia</title><link rel="short icon" href="/favicon.ico"><!-- font--><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600|Roboto Mono"><!-- icon--><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><!-- theme style--><link rel="stylesheet" href="/css/style.css"><!-- baidu analytics--><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?9e0cbea7d3319c6c94c71dfb93c151b8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><!-- google analytics--><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-74273646-1', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">gzmviavia</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">首页</a></li><li class="nav-link"><a href="/archives/" target="_self">归档</a></li><li class="nav-link"><a href="/categories/" target="_self">分类</a></li><li class="nav-link"><a href="/tags/" target="_self">标签</a></li><li class="nav-link"><a href="/about/" target="_self">关于</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Python多线程模块threading源码</h1><span class="post-time">2016年8月20日</span><div id="sidebar" class="post-sidebar"><h3 class="heading">目录</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#threading-Thread"><span class="toc-text">threading.Thread</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#threading-Lock"><span class="toc-text">threading.Lock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#threading-RLock"><span class="toc-text">threading.RLock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#threading-Condition"><span class="toc-text">threading.Condition</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#threading-Event"><span class="toc-text">threading.Event</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#threading-Semaphore"><span class="toc-text">threading.Semaphore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#threading-BoundedSemaphore"><span class="toc-text">threading.BoundedSemaphore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#threading-Timer"><span class="toc-text">threading.Timer</span></a></li></ol></div><div class="post-content"><p>threading&#x6A21;&#x5757;&#x5305;&#x542B;&#x4E86;&#xFF1A;</p>
<ul>
<li>&#x7EBF;&#x7A0B;&#x5BF9;&#x8C61;Thread</li>
<li>&#x666E;&#x901A;&#x9501;&#x5BF9;&#x8C61;Lock</li>
<li>&#x53EF;&#x91CD;&#x5165;&#x9501;&#x5BF9;&#x8C61;RLock</li>
<li>&#x6761;&#x4EF6;&#x9501;&#x5BF9;&#x8C61;Condition</li>
<li>&#x4E8B;&#x4EF6;&#x5BF9;&#x8C61;Event</li>
<li>&#x4FE1;&#x53F7;&#x91CF;&#x5BF9;&#x8C61;Semaphore</li>
<li>&#x5B9A;&#x65F6;&#x5668;&#x5BF9;&#x8C61;Timer</li>
</ul>
<a id="more"></a>
<h2 id="threading-Thread"><a href="#threading-Thread" class="headerlink" title="threading.Thread"></a>threading.Thread</h2><h2 id="threading-Lock"><a href="#threading-Lock" class="headerlink" title="threading.Lock"></a>threading.Lock</h2><p>&#x9501;&#x5BF9;&#x8C61;Lock&#x5728;threading&#x6A21;&#x5757;&#x4E2D;&#x7684;&#x5B9A;&#x4E49;&#x53EA;&#x6709;&#x4E24;&#x53E5;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;Lock&#x5176;&#x5B9E;&#x5C31;&#x662F;thread&#x4E2D;&#x7684;allocate_lock&#x51FD;&#x6570;&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x9501;&#x5BF9;&#x8C61;&#x53EA;&#x6709;<strong>locked</strong>&#x548C;<strong>unlocked</strong>&#x4E24;&#x79CD;&#x72B6;&#x6001;&#xFF0C;&#x5F53;&#x5904;&#x4E8E;<strong>locked</strong>&#x72B6;&#x6001;&#x65F6;&#xFF0C;&#x5B83;&#x662F;&#x6CA1;&#x6709;&#x62E5;&#x6709;&#x8005;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x7684;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x7EBF;&#x7A0B;A&#x8C03;&#x7528;&#x4E86;acquire()&#x51FD;&#x6570;&#x83B7;&#x53D6;&#x4E86;&#x9501;&#xFF0C;&#x5E76;&#x4E0D;&#x4E00;&#x5B9A;&#x8BF4;&#x53EA;&#x80FD;&#x7531;A&#x6765;&#x8C03;&#x7528;release()&#x51FD;&#x6570;&#x91CA;&#x653E;&#x8BE5;&#x9501;&#xFF0C;&#x53EF;&#x4EE5;&#x7531;&#x7EBF;&#x7A0B;B&#x8C03;&#x7528;release()&#x51FD;&#x6570;&#x6765;&#x91CA;&#x653E;&#x8BE5;&#x9501;&#x3002;</p>
<p>&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x7279;&#x6027;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x9501;&#x5BF9;&#x8C61;&#x662F;&#x4E0D;&#x53EF;&#x91CD;&#x5165;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5982;&#x679C;&#x7EBF;&#x7A0B;A&#x8C03;&#x7528;&#x4E86;acquire()&#x51FD;&#x6570;&#x83B7;&#x53D6;&#x4E86;&#x8BE5;&#x9501;&#xFF0C;&#x5982;&#x679C;&#x7EBF;&#x7A0B;A&#x518D;&#x6B21;&#x8C03;&#x7528;acquire()&#x51FD;&#x6570;&#x83B7;&#x53D6;&#x9501;&#xFF0C;&#x90A3;&#x4E48;&#x7EBF;&#x7A0B;A&#x5C31;&#x4F1A;&#x9677;&#x5165;&#x6B7B;&#x9501;&#xFF0C;&#x9664;&#x975E;&#x6709;&#x5176;&#x5B83;&#x7EBF;&#x7A0B;&#x8C03;&#x7528;&#x4E86;release()&#x51FD;&#x6570;&#x91CA;&#x653E;&#x8BE5;&#x9501;&#x3002;<strong>Condition</strong>&#x5BF9;&#x8C61;&#x5C31;&#x662F;&#x4F7F;&#x7528;&#x8FD9;&#x4E24;&#x4E2A;&#x7279;&#x6027;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">_allocate_lock = thread.allocate_lock</div><div class="line">Lock = _allocate_lock</div></pre></td></tr></table></figure>
<h2 id="threading-RLock"><a href="#threading-RLock" class="headerlink" title="threading.RLock"></a>threading.RLock</h2><p>RLock&#x5BF9;&#x8C61;&#x7684;&#x5185;&#x90E8;&#x662F;&#x4F7F;&#x7528;Lock&#x5BF9;&#x8C61;&#x6765;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x4E0D;&#x8FC7;&#x53C8;&#x589E;&#x6DFB;&#x4E86;&#x67D0;&#x4E9B;&#x529F;&#x80FD;&#x3002;</p>
<ul>
<li>RLock&#x5BF9;&#x8C61;&#x662F;&#x6709;&#x62E5;&#x6709;&#x8005;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x7684;&#xFF0C;&#x5373;&#x53EA;&#x80FD;&#x7531;&#x83B7;&#x5F97;&#x4E86;RLock&#x5BF9;&#x8C61;&#x7684;&#x7EBF;&#x7A0B;&#x6765;&#x8C03;&#x7528;release&#x51FD;&#x6570;&#x6765;&#x91CA;&#x653E;&#x9501;&#x3002;</li>
<li>RLock&#x5BF9;&#x8C61;&#x662F;&#x53EF;&#x91CD;&#x5165;&#x7684;&#xFF0C;&#x5373;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x53EF;&#x4EE5;&#x591A;&#x6B21;&#x83B7;&#x5F97;RLock&#x5BF9;&#x8C61;&#xFF0C;RLock&#x5BF9;&#x8C61;&#x4F1A;&#x5728;&#x5185;&#x90E8;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x8BA1;&#x6570;&#xFF0C;&#x7EDF;&#x8BA1;&#x8BE5;&#x7EBF;&#x7A0B;&#x83B7;&#x5F97;&#x4E86;&#x81EA;&#x5DF1;&#x591A;&#x5C11;&#x6B21;&#xFF0C;&#x91CA;&#x653E;&#x8BE5;&#x9501;&#x65F6;&#xFF0C;&#x4F1A;&#x5728;&#x5185;&#x90E8;&#x5C06;&#x8BA1;&#x6570;&#x51CF;1&#xFF0C;&#x53EA;&#x6709;&#x5F53;&#x8BA1;&#x6570;&#x4E3A;0&#x65F6;&#x624D;&#x771F;&#x6B63;&#x5730;&#x91CA;&#x653E;&#x4E86;&#x8BE5;&#x9501;&#x3002;</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">RLock</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">	<span class="string">&apos;&apos;&apos;</span></div><div class="line">	&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;RLock&#x5176;&#x5B9E;&#x662F;&#x4E00;&#x4E2A;&#x5DE5;&#x5382;&#x51FD;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x53EF;&#x91CD;&#x5165;&#x9501;&#x5BF9;&#x8C61;&#x3002;</div><div class="line">	&#x53EF;&#x91CD;&#x5165;&#x9501;&#x662F;&#x6709;&#x62E5;&#x6709;&#x8005;&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x7684;&#xFF0C;&#x54EA;&#x4E2A;&#x7EBF;&#x7A0B;&#x83B7;&#x53D6;&#x4E86;&#x8BE5;&#x9501;&#xFF0C;&#x90A3;&#x4E48;&#x54EA;&#x4E2A;&#x5C31;&#x662F;&#x8BE5;&#x9501;&#x7684;&#x62E5;&#x6709;&#x8005;&#xFF0C;</div><div class="line">	&#x53EA;&#x6709;&#x62E5;&#x6709;&#x8005;&#x624D;&#x80FD;&#x591F;&#x91CA;&#x653E;&#x8BE5;&#x9501;&#xFF0C;&#x5982;&#x679C;&#x975E;&#x62E5;&#x6709;&#x8005;&#x91CA;&#x653E;&#x8BE5;&#x9501;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x5F15;&#x8D77;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x3002;</div><div class="line">	&apos;&apos;&apos;</div><div class="line">    <span class="keyword">return</span> _RLock(*args, **kwargs)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_RLock</span><span class="params">(_Verbose)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, verbose=None)</span>:</span></div><div class="line">	<span class="string">&apos;&apos;&apos;</span></div><div class="line">	&#x53EF;&#x4EE5;&#x770B;&#x51FA;RLock&#x5BF9;&#x8C61;&#x5185;&#x90E8;&#x4E5F;&#x662F;&#x57FA;&#x4E8E;thread.allocate_lock&#x7684;&#xFF0C;</div><div class="line">	self.__owner&#x8868;&#x793A;&#x8BE5;&#x9501;&#x7684;&#x62E5;&#x6709;&#x8005;</div><div class="line">	self.__count&#x7528;&#x6765;&#x8BB0;&#x5F55;&#x8BE5;&#x9501;&#x88AB;&#x540C;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x83B7;&#x53D6;&#x4E86;&#x51E0;&#x6B21;&#xFF0C;</div><div class="line">	&#x9501;&#x7684;&#x62E5;&#x6709;&#x8005;&#x6BCF;&#x8C03;&#x7528;&#x4E00;&#x6B21;release()&#x5C31;&#x5C06;self.__count&#x51CF;1&#xFF0C;&#x5F53;&#x5176;&#x4E3A;0&#x65F6;&#x624D;&#x80FD;&#x591F;</div><div class="line">	&#x91CA;&#x653E;self.__block</div><div class="line">	&apos;&apos;&apos;</div><div class="line">        _Verbose.__init__(self, verbose)</div><div class="line">        self.__block = _allocate_lock()</div><div class="line">        self.__owner = <span class="keyword">None</span></div><div class="line">        self.__count = <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        owner = self.__owner</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            owner = _active[owner].name</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;%s owner=%r count=%d&gt;&quot;</span> % (</div><div class="line">                self.__class__.__name__, owner, self.__count)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self, blocking=<span class="number">1</span>)</span>:</span></div><div class="line">	<span class="comment">#_get_ident&#x662F;&#x83B7;&#x53D6;&#x7EBF;&#x7A0B;id&#x7684;&#x51FD;&#x6570;</span></div><div class="line">        me = _get_ident()</div><div class="line">	<span class="comment">#&#x5982;&#x679C;&#x662F;&#x9501;&#x7684;&#x62E5;&#x6709;&#x8005;&#x518D;&#x6B21;&#x83B7;&#x53D6;&#x8BE5;&#x9501;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x5C06;self.__count + 1</span></div><div class="line">        <span class="keyword">if</span> self.__owner == me:</div><div class="line">            self.__count = self.__count + <span class="number">1</span></div><div class="line">            <span class="keyword">if</span> __debug__:</div><div class="line">                self._note(<span class="string">&quot;%s.acquire(%s): recursive success&quot;</span>, self, blocking)</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span></div><div class="line"></div><div class="line">	<span class="comment">#&#x5982;&#x679C;&#x4E0D;&#x662F;&#x8BE5;&#x9501;&#x7684;&#x62E5;&#x6709;&#x8005;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x8BA9;&#x5176;&#x83B7;&#x53D6;&#x9501;</span></div><div class="line">        rc = self.__block.acquire(blocking)</div><div class="line"></div><div class="line">	<span class="comment">#&#x5982;&#x679C;&#x6210;&#x529F;&#x83B7;&#x53D6;&#x5230;&#x4E86;&#x8BE5;&#x9501;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4FEE;&#x6539;self.__owner&#x548C;self.__count</span></div><div class="line">        <span class="keyword">if</span> rc:</div><div class="line">            self.__owner = me</div><div class="line">            self.__count = <span class="number">1</span></div><div class="line">            <span class="keyword">if</span> __debug__:</div><div class="line">                self._note(<span class="string">&quot;%s.acquire(%s): initial success&quot;</span>, self, blocking)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">if</span> __debug__:</div><div class="line">                self._note(<span class="string">&quot;%s.acquire(%s): failure&quot;</span>, self, blocking)</div><div class="line">        <span class="keyword">return</span> rc</div><div class="line"></div><div class="line">    __enter__ = acquire</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self)</span>:</span></div><div class="line">	<span class="comment">#&#x5982;&#x679C;&#x4E0D;&#x662F;&#x9501;&#x7684;&#x62E5;&#x6709;&#x8005;&#x91CA;&#x653E;&#x8BE5;&#x9501;&#xFF0C;&#x90A3;&#x5C31;&#x4F1A;&#x5F15;&#x8D77;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x3002;</span></div><div class="line">        <span class="keyword">if</span> self.__owner != _get_ident():</div><div class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;cannot release un-acquired lock&quot;</span>)</div><div class="line">	<span class="comment">#&#x91CA;&#x653E;&#x9501;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5C06;&#x9501;&#x7684;self.__count&#x51CF;1</span></div><div class="line">        self.__count = count = self.__count - <span class="number">1</span></div><div class="line">	<span class="comment">#&#x5F53;self.__count&#x51CF;&#x4E3A;0&#x65F6;&#xFF0C;&#x624D;&#x80FD;&#x591F;&#x91CA;&#x653E;self.__block</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> count:</div><div class="line">            self.__owner = <span class="keyword">None</span></div><div class="line">            self.__block.release()</div><div class="line">            <span class="keyword">if</span> __debug__:</div><div class="line">                self._note(<span class="string">&quot;%s.release(): final release&quot;</span>, self)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">if</span> __debug__:</div><div class="line">                self._note(<span class="string">&quot;%s.release(): non-final release&quot;</span>, self)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, t, v, tb)</span>:</span></div><div class="line">        self.release()</div><div class="line"></div><div class="line">	</div><div class="line">	<span class="comment">#&#x4E0B;&#x9762;&#x7684;&#x8FD9;&#x4E9B;&#x5185;&#x90E8;&#x65B9;&#x6CD5;&#x662F;&#x7ED9;Condition&#x5BF9;&#x8C61;&#x4F7F;&#x7528;&#x7684;</span></div><div class="line">	<span class="comment">#Condition&#x5BF9;&#x8C61;&#x7684;&#x5185;&#x90E8;&#x4F9D;&#x8D56;&#x4E8E;&#x9501;&#x5BF9;&#x8C61;&#xFF0C;&#x53EF;&#x4EE5;&#x662F;Lock&#x5BF9;&#x8C61;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x662F;RLock&#x5BF9;&#x8C61;&#x3002;</span></div><div class="line">	<span class="comment">#&#x5982;&#x679C;&#x662F;RLock&#x5BF9;&#x8C61;&#x7684;&#x8BDD;&#xFF0C;&#x60C5;&#x51B5;&#x6BD4;&#x8F83;&#x7279;&#x6B8A;&#x3002;</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_release_save</span><span class="params">(self)</span>:</span></div><div class="line">	<span class="comment">#&#x5F53;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x8C03;&#x7528;Condition&#x5BF9;&#x8C61;&#x7684;wait&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x8868;&#x793A;&#x91CA;&#x653E;&#x9501;&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x5165;&#x4F11;&#x7720;</span></div><div class="line">	<span class="comment">#&#x90A3;&#x5C31;&#x9700;&#x8981;&#x4FDD;&#x5B58;&#x73B0;&#x573A;&#xFF0C;&#x5F53;&#x7EBF;&#x7A0B;&#x82CF;&#x9192;&#x5E76;&#x518D;&#x6B21;&#x83B7;&#x53D6;&#x8BE5;&#x9501;&#x65F6;&#x5C31;&#x9700;&#x8981;&#x6062;&#x590D;&#x73B0;&#x573A;&#x3002;</span></div><div class="line">        <span class="keyword">if</span> __debug__:</div><div class="line">            self._note(<span class="string">&quot;%s._release_save()&quot;</span>, self)</div><div class="line">        count = self.__count</div><div class="line">        self.__count = <span class="number">0</span></div><div class="line">        owner = self.__owner</div><div class="line">        self.__owner = <span class="keyword">None</span></div><div class="line">        self.__block.release()</div><div class="line">        <span class="keyword">return</span> (count, owner)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_acquire_restore</span><span class="params">(self, count_owner)</span>:</span></div><div class="line">	<span class="comment">#&#x6839;&#x636E;&#x4F20;&#x8FDB;&#x6765;&#x7684;count_owner&#x5BF9;&#x8C61;&#x6062;&#x590D;&#x73B0;&#x573A;</span></div><div class="line">        count, owner = count_owner</div><div class="line">        self.__block.acquire()</div><div class="line">        self.__count = count</div><div class="line">        self.__owner = owner</div><div class="line">        <span class="keyword">if</span> __debug__:</div><div class="line">            self._note(<span class="string">&quot;%s._acquire_restore()&quot;</span>, self)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_is_owned</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.__owner == _get_ident()</div></pre></td></tr></table></figure>
<h2 id="threading-Condition"><a href="#threading-Condition" class="headerlink" title="threading.Condition"></a>threading.Condition</h2><p>&#x8003;&#x8651;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;&#x573A;&#x666F;&#xFF0C;&#x591A;&#x7EBF;&#x7A0B;&#x9700;&#x8981;&#x4E92;&#x65A5;&#x8BBF;&#x95EE;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#xFF0C;&#x67D0;&#x4E9B;&#x7EBF;&#x7A0B;&#x4ECE;&#x961F;&#x5217;&#x4E2D;&#x8BFB;&#x53D6;&#x5143;&#x7D20;&#xFF0C;&#x5E76;&#x5220;&#x9664;&#x8BFB;&#x53D6;&#x7684;&#x5143;&#x7D20;&#xFF1B;&#x67D0;&#x4E9B;&#x7EBF;&#x7A0B;&#x5C06;&#x5143;&#x7D20;&#x52A0;&#x5165;&#x5230;&#x961F;&#x5217;&#x4E2D;&#x3002;&#x5982;&#x679C;&#x8BFB;&#x53D6;&#x5143;&#x7D20;&#x7684;&#x7EBF;&#x7A0B;&#x83B7;&#x5F97;&#x4E86;&#x9501;&#xFF0C;&#x5F53;&#x65F6;&#x53D1;&#x73B0;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;&#x4E0D;&#x6EE1;&#x8DB3;&#xFF0C;&#x5373;&#x961F;&#x5217;&#x4E3A;&#x7A7A;&#xFF0C;&#x5B83;&#x65E0;&#x6CD5;&#x83B7;&#x5F97;&#x5143;&#x7D20;&#x3002;&#x90A3;&#x4E48;&#x6B64;&#x65F6;&#x4E00;&#x4E2A;&#x9009;&#x62E9;&#x5C31;&#x662F;&#x8BE5;&#x7EBF;&#x7A0B;&#x91CA;&#x653E;&#x9501;&#xFF0C;&#x7B49;&#x5F85;&#x7EBF;&#x4E0B;&#x6B21;&#x83B7;&#x5F97;&#x9501;&#x65F6;&#x518D;&#x67E5;&#x770B;&#x961F;&#x5217;&#x4E2D;&#x6709;&#x6CA1;&#x6709;&#x5143;&#x7D20;&#x3002;&#x53E6;&#x4E00;&#x4E2A;&#x9009;&#x62E9;&#x5C31;&#x662F;&#x4F7F;&#x5F97;&#x8BE5;&#x7EBF;&#x7A0B;&#x963B;&#x585E;&#x5728;&#x8BE5;&#x9501;&#x4E0A;&#xFF0C;&#x5F53;&#x5176;&#x4ED6;&#x5199;&#x7EBF;&#x7A0B;&#x5411;&#x961F;&#x5217;&#x4E2D;&#x52A0;&#x5165;&#x5143;&#x7D20;&#x540E;&#xFF0C;&#x5C31;&#x5524;&#x9192;&#x963B;&#x585E;&#x5728;&#x8BE5;&#x9501;&#x4E0A;&#x7684;&#x7EBF;&#x7A0B;&#x3002;</p>
<p>&#x4F7F;&#x7528;&#x6761;&#x4EF6;&#x9501;&#x5C31;&#x80FD;&#x4F7F;&#x5F97;&#x5F53;&#x83B7;&#x5F97;&#x9501;&#x7684;&#x67D0;&#x4E2A;&#x7EBF;&#x7A0B;&#x53D1;&#x73B0;&#x6240;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;&#x4E0D;&#x6EE1;&#x8DB3;&#x65F6;&#xFF0C;&#x4F7F;&#x81EA;&#x5DF1;&#x963B;&#x585E;&#x5728;&#x8BE5;&#x9501;&#x4E0A;&#x3002;</p>
<ul>
<li>&#x6761;&#x4EF6;&#x9501;&#x7684;&#x5185;&#x90E8;&#x662F;&#x4F7F;&#x7528;Lock&#x6216;&#x8005;RLock&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x53C2;&#x6570;&#x6307;&#x5B9A;&#x5176;&#x901A;&#x8FC7;&#x54EA;&#x79CD;&#x9501;&#x5B9E;&#x73B0;&#x3002;&#x6761;&#x4EF6;&#x9501;&#x5728;&#x6B64;&#x57FA;&#x7840;&#x4E0A;&#x589E;&#x52A0;&#x4E86;&#x963B;&#x585E;&#x7B49;&#x5F85;&#x7684;&#x529F;&#x80FD;&#x3002;</li>
<li>&#x6761;&#x4EF6;&#x9501;&#x5185;&#x90E8;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x963B;&#x585E;&#x961F;&#x5217;&#xFF0C;&#x5F53;&#x7EBF;&#x7A0B;&#x8C03;&#x7528;wait&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x5C31;&#x5C06;&#x7EBF;&#x7A0B;&#x52A0;&#x5165;&#x963B;&#x585E;&#x961F;&#x5217;&#xFF08;&#x5177;&#x4F53;&#x4E0D;&#x662F;&#x8FD9;&#x6837;&#xFF0C;&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x7406;&#x89E3;&#x6240;&#x4EE5;&#x8FD9;&#x6837;&#x8BF4;&#xFF09;&#x3002;&#x5F53;&#x5176;&#x5B83;&#x7EBF;&#x7A0B;&#x8C03;&#x7528;notify&#x65B9;&#x6CD5;&#x65F6;&#x5C31;&#x5524;&#x9192;&#x961F;&#x5217;&#x4E2D;&#x7684;&#x5143;&#x7D20;&#x3002;notify&#x65B9;&#x6CD5;&#x9ED8;&#x8BA4;&#x5524;&#x9192;&#x961F;&#x5217;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x53C2;&#x6570;&#xFF0C;&#x4F7F;&#x5176;&#x5524;&#x9192;&#x524D;n&#x4E2A;&#x7EBF;&#x7A0B;&#x3002;</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Condition</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">	<span class="string">&apos;&apos;&apos;</span></div><div class="line">	&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x8FD9;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x3002;</div><div class="line">	&#x6761;&#x4EF6;&#x9501;&#x5185;&#x90E8;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x963B;&#x585E;&#x961F;&#x5217;&#xFF0C;&#x5F53;&#x83B7;&#x53D6;&#x4E86;&#x9501;&#x7684;&#x7EBF;&#x7A0B;&#x5BF9;&#x8C61;&#x5982;&#x679C;&#x5224;&#x65AD;&#x67D0;&#x4E9B;&#x6761;&#x4EF6;&#x4E0D;&#x6EE1;&#x8DB3;&#x5BFC;&#x81F4;&#x65E0;&#x6CD5;&#x5F80;&#x4E0B;&#x6267;&#x884C;&#xFF0C;</div><div class="line">	&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x8C03;&#x7528;wait&#x65B9;&#x6CD5;&#xFF0C;&#x5F53;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x5BF9;&#x8C61;&#x6EE1;&#x8DB3;&#x4E86;&#x8FD9;&#x4E9B;&#x6761;&#x4EF6;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x8C03;&#x7528;notify&#x65B9;&#x6CD5;&#x6765;&#x5524;&#x9192;&#x961F;&#x5217;&#x4E2D;&#x7684;&#x7EBF;&#x7A0B;&#x3002;</div><div class="line">	&apos;&apos;&apos;</div><div class="line">    <span class="keyword">return</span> _Condition(*args, **kwargs)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_Condition</span><span class="params">(_Verbose)</span>:</span></div><div class="line">	<span class="string">&apos;&apos;&apos;</span></div><div class="line">	&#x6761;&#x4EF6;&#x9501;&#x5BF9;&#x8C61;&#x5141;&#x8BB8;&#x591A;&#x4E2A;&#x7EBF;&#x7A0B;&#x5728;&#x5176;&#x963B;&#x585E;&#x961F;&#x5217;&#x4E2D;&#x7B49;&#x5F85;&#xFF0C;&#x76F4;&#x5230;&#x88AB;&#x5176;&#x5B83;&#x7EBF;&#x7A0B;&#x5524;&#x9192;</div><div class="line">	&apos;&apos;&apos;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, lock=None, verbose=None)</span>:</span></div><div class="line">        _Verbose.__init__(self, verbose)</div><div class="line">		<span class="comment">#&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x6761;&#x4EF6;&#x9501;&#x5185;&#x90E8;&#x6240;&#x4F7F;&#x7528;&#x7684;&#x9501;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x6307;&#x5B9A;&#xFF0C;&#x90A3;&#x4E48;&#x5185;&#x90E8;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;RLock&#xFF0C;&#x56E0;&#x4E3A;&#x8BE5;&#x9501;&#x66F4;&#x5B89;&#x5168;&#x3002;</span></div><div class="line">        <span class="keyword">if</span> lock <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            lock = RLock()</div><div class="line">        self.__lock = lock</div><div class="line">		<span class="comment">#&#x5BFC;&#x5165;&#x9501;&#x7684;&#x65B9;&#x6CD5;&#x5230;&#x81EA;&#x8EAB;</span></div><div class="line">        self.acquire = lock.acquire</div><div class="line">        self.release = lock.release</div><div class="line"></div><div class="line">		<span class="comment">#Condition&#x5185;&#x90E8;&#x5DF2;&#x7ECF;&#x5B9E;&#x73B0;&#x4E86;&#x4E0B;&#x9762;&#x7684;&#x65B9;&#x6CD5;</span></div><div class="line">		<span class="comment">#&#x4F46;&#x662F;&#x5982;&#x679C;&#x4F7F;&#x7528;&#x7684;&#x662F;RLock&#x5BF9;&#x8C61;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x9700;&#x8981;&#x8986;&#x76D6;&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;</span></div><div class="line">		<span class="comment">#&#x56E0;&#x4E3A;RLock&#x5BF9;&#x8C61;&#x5728;Condition&#x5BF9;&#x8C61;&#x88AB;&#x8C03;&#x7528;wait&#x65F6;&#x9700;&#x8981;&#x4FDD;&#x5B58;&#x73B0;&#x573A;</span></div><div class="line">		<span class="comment">#&#x548C;&#x6062;&#x590D;&#x73B0;&#x573A;&#x3002;</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self._release_save = lock._release_save</div><div class="line">        <span class="keyword">except</span> AttributeError:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self._acquire_restore = lock._acquire_restore</div><div class="line">        <span class="keyword">except</span> AttributeError:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self._is_owned = lock._is_owned</div><div class="line">        <span class="keyword">except</span> AttributeError:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">		<span class="comment">#&#x963B;&#x585E;&#x961F;&#x5217;</span></div><div class="line">        self.__waiters = []</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.__lock.__enter__()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, *args)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.__lock.__exit__(*args)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;Condition(%s, %d)&gt;&quot;</span> % (self.__lock, len(self.__waiters))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_release_save</span><span class="params">(self)</span>:</span></div><div class="line">        self.__lock.release()           <span class="comment"># No state to save</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_acquire_restore</span><span class="params">(self, x)</span>:</span></div><div class="line">        self.__lock.acquire()           <span class="comment"># Ignore saved state</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_is_owned</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># Return True if lock is owned by current_thread.</span></div><div class="line">        <span class="comment"># This method is called only if __lock doesn&apos;t have _is_owned().</span></div><div class="line">        <span class="keyword">if</span> self.__lock.acquire(<span class="number">0</span>):</div><div class="line">            self.__lock.release()</div><div class="line">            <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self, timeout=None)</span>:</span></div><div class="line">	<span class="string">&apos;&apos;&apos;</span></div><div class="line">	&#x963B;&#x585E;&#x7B49;&#x5F85;&#x76F4;&#x5230;&#x5176;&#x5B83;&#x7EBF;&#x7A0B;&#x8C03;&#x7528;&#x4E86;notify&#x51FD;&#x6570;&#xFF0C;&#x6216;&#x8005;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x5230;&#x4E86;&#x3002;</div><div class="line">	&#x53EA;&#x6709;&#x83B7;&#x5F97;&#x4E86;&#x9501;&#x7684;&#x7EBF;&#x7A0B;&#x624D;&#x80FD;&#x591F;&#x8C03;&#x7528;wait&#x51FD;&#x6570;</div><div class="line">	&apos;&apos;&apos;</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._is_owned():</div><div class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;cannot wait on un-acquired lock&quot;</span>)</div><div class="line"></div><div class="line">	<span class="comment">#&#x8BA9;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;wait&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5206;&#x914D;&#x7ED9;&#x8BE5;&#x7EBF;&#x7A0B;&#x4E00;&#x4E2A;&#x9501;&#xFF0C;&#x7136;&#x540E;&#x8BA9;&#x5176;&#x8FDE;&#x7EED;&#x4E24;&#x6B21;&#x8C03;&#x7528;&#x9501;&#x7684;acquire()&#x65B9;&#x6CD5;</span></div><div class="line">        waiter = _allocate_lock()</div><div class="line">	<span class="comment">#&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528;</span></div><div class="line">        waiter.acquire()</div><div class="line">	<span class="comment">#&#x963B;&#x585E;&#x961F;&#x5217;&#x4E2D;&#x5B58;&#x7684;&#x662F;&#x9501;&#x5BF9;&#x8C61;&#xFF0C;&#x5176;&#x5B9E;&#x7EBF;&#x7A0B;notify&#x65F6;&#x5176;&#x5B9E;&#x5C31;&#x662F;release&#x963B;&#x585E;&#x961F;&#x5217;&#x4E2D;&#x7684;&#x9501;&#x5BF9;&#x8C61;&#x3002;</span></div><div class="line">        self.__waiters.append(waiter)</div><div class="line">        saved_state = self._release_save()</div><div class="line">        <span class="keyword">try</span>:    <span class="comment"># restore state no matter what (e.g., KeyboardInterrupt)</span></div><div class="line">            <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">			<span class="comment">#&#x7B2C;&#x4E8C;&#x6B21;&#x8C03;&#x7528;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#x8D85;&#x65F6;&#x65F6;&#x95F4;</span></div><div class="line">                waiter.acquire()</div><div class="line">                <span class="keyword">if</span> __debug__:</div><div class="line">                    self._note(<span class="string">&quot;%s.wait(): got it&quot;</span>, self)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">			<span class="comment">#&#x5982;&#x679C;&#x4F7F;&#x7528;&#x6B7B;&#x5FAA;&#x73AF;&#x6765;&#x4E0D;&#x65AD;&#x5730;&#x83B7;&#x5F97;&#x9501;&#xFF0C;&#x90A3;&#x4E48;&#x592A;&#x8017;&#x8D39;CPU&#x8D44;&#x6E90;&#x4E86;</span></div><div class="line">			<span class="comment">#&#x6240;&#x4EE5;&#x6BCF;&#x9694;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x83B7;&#x5F97;&#x9501;&#x4E00;&#x6B21;&#xFF0C;&#x5982;&#x679C;&#x83B7;&#x5F97;&#x9501;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x8DF3;&#x51FA;&#x5FAA;&#x73AF;</span></div><div class="line">			<span class="comment">#&#x5426;&#x5219;&#x5C31;&#x7EE7;&#x7EED;sleep&#xFF0C;&#x76F4;&#x5230;&#x7761;&#x7720;&#x7684;&#x603B;&#x65F6;&#x95F4;&#x8FBE;&#x5230;&#x4E86;timeout&#x3002;</span></div><div class="line">                endtime = _time() + timeout</div><div class="line">                delay = <span class="number">0.0005</span> <span class="comment"># 500 us -&gt; initial delay of 1 ms</span></div><div class="line">                <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">                    gotit = waiter.acquire(<span class="number">0</span>)</div><div class="line">                    <span class="keyword">if</span> gotit:</div><div class="line">                        <span class="keyword">break</span></div><div class="line">                    remaining = endtime - _time()</div><div class="line">                    <span class="keyword">if</span> remaining &lt;= <span class="number">0</span>:</div><div class="line">                        <span class="keyword">break</span></div><div class="line">                    delay = min(delay * <span class="number">2</span>, remaining, <span class="number">.05</span>)</div><div class="line">                    _sleep(delay)</div><div class="line">                <span class="keyword">if</span> <span class="keyword">not</span> gotit:</div><div class="line">                    <span class="keyword">if</span> __debug__:</div><div class="line">                        self._note(<span class="string">&quot;%s.wait(%s): timed out&quot;</span>, self, timeout)</div><div class="line">                    <span class="keyword">try</span>:</div><div class="line">                        self.__waiters.remove(waiter)</div><div class="line">                    <span class="keyword">except</span> ValueError:</div><div class="line">                        <span class="keyword">pass</span></div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    <span class="keyword">if</span> __debug__:</div><div class="line">                        self._note(<span class="string">&quot;%s.wait(%s): got it&quot;</span>, self, timeout)</div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            self._acquire_restore(saved_state)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notify</span><span class="params">(self, n=<span class="number">1</span>)</span>:</span></div><div class="line">	<span class="comment">#&#x53EA;&#x6709;&#x9501;&#x7684;&#x62E5;&#x6709;&#x8005;&#x624D;&#x80FD;&#x8C03;&#x7528;notify</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._is_owned():</div><div class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;cannot notify on un-acquired lock&quot;</span>)</div><div class="line">        __waiters = self.__waiters</div><div class="line">        waiters = __waiters[:n]</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> waiters:</div><div class="line">            <span class="keyword">if</span> __debug__:</div><div class="line">                self._note(<span class="string">&quot;%s.notify(): no waiters&quot;</span>, self)</div><div class="line">            <span class="keyword">return</span></div><div class="line">        self._note(<span class="string">&quot;%s.notify(): notifying %d waiter%s&quot;</span>, self, n,</div><div class="line">                   n!=<span class="number">1</span> <span class="keyword">and</span> <span class="string">&quot;s&quot;</span> <span class="keyword">or</span> <span class="string">&quot;&quot;</span>)</div><div class="line">        <span class="keyword">for</span> waiter <span class="keyword">in</span> waiters:</div><div class="line">		<span class="comment">#&#x91CA;&#x653E;&#x9501;&#xFF0C;&#x90A3;&#x4E48;&#x963B;&#x585E;&#x961F;&#x5217;&#x4E2D;&#x7684;&#x7EBF;&#x7A0B;&#x5C31;&#x4F1A;&#x88AB;&#x89E3;&#x9664;&#x6B7B;&#x9501;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x4ECE;&#x800C;&#x80FD;&#x591F;&#x5F80;&#x4E0B;&#x6267;&#x884C;&#x3002;</span></div><div class="line">            waiter.release()</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                __waiters.remove(waiter)</div><div class="line">            <span class="keyword">except</span> ValueError:</div><div class="line">                <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notifyAll</span><span class="params">(self)</span>:</span></div><div class="line">	<span class="comment">#&#x5524;&#x9192;&#x7B49;&#x5F85;&#x961F;&#x5217;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x7EBF;&#x7A0B;</span></div><div class="line">        self.notify(len(self.__waiters))</div><div class="line"></div><div class="line">    notify_all = notifyAll</div></pre></td></tr></table></figure>
<h2 id="threading-Event"><a href="#threading-Event" class="headerlink" title="threading.Event"></a>threading.Event</h2><p>Event&#x5BF9;&#x8C61;&#x662F;&#x4E00;&#x4E2A;&#x7279;&#x6B8A;&#x7684;&#x6761;&#x4EF6;&#x9501;&#x5BF9;&#x8C61;&#xFF0C;&#x5176;&#x5185;&#x90E8;&#x662F;&#x57FA;&#x7840;Condition&#x5BF9;&#x8C61;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<ul>
<li>Event&#x662F;&#x67D0;&#x4E9B;&#x573A;&#x666F;&#x4E0B;&#x7684;&#x6761;&#x4EF6;&#x9501;&#xFF0C;&#x6BD4;&#x5982;&#x591A;&#x5C11;&#x7EBF;&#x7A0B;&#x7B49;&#x5F85;&#x67D0;&#x4E2A;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#xFF0C;&#x5728;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#x540E;&#xFF0C;&#x6240;&#x6709;&#x7684;&#x7EBF;&#x7A0B;&#x90FD;&#x4F1A;&#x88AB;&#x6FC0;&#x6D3B;&#x3002;&#x6BD4;&#x5982;&#x8BF4;&#x4E3B;&#x7EBF;&#x7A0B;&#x5B8C;&#x6210;&#x521D;&#x59CB;&#x5316;&#x529F;&#x80FD;&#x540E;&#xFF0C;&#x5C31;&#x76F8;&#x5F53;&#x4E8E;&#x67D0;&#x4E2A;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#x4E86;&#xFF0C;&#x90A3;&#x4E48;&#x6240;&#x6709;&#x7684;&#x5B50;&#x7EBF;&#x7A0B;&#x90FD;&#x5E94;&#x5F53;&#x88AB;&#x6FC0;&#x6D3B;&#xFF0C;&#x7136;&#x540E;&#x5F00;&#x59CB;&#x5404;&#x81EA;&#x7684;&#x5DE5;&#x4F5C;&#x3002;</li>
<li>&#x6240;&#x4EE5;&#x8BF4;&#x8FD9;&#x53EF;&#x4EE5;&#x770B;&#x505A;&#x662F;&#x7EBF;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x7684;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x8FD9;&#x79CD;&#x901A;&#x4FE1;&#x65B9;&#x6CD5;&#x80FD;&#x591F;&#x4F20;&#x9012;&#x7684;&#x6D88;&#x606F;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#x3002;<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Event</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">	<span class="string">&apos;&apos;&apos;</span></div><div class="line">	&#x5DE5;&#x5382;&#x65B9;&#x6CD5;</div><div class="line">	&apos;&apos;&apos;</div><div class="line">    <span class="keyword">return</span> _Event(*args, **kwargs)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_Event</span><span class="params">(_Verbose)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, verbose=None)</span>:</span></div><div class="line">        _Verbose.__init__(self, verbose)</div><div class="line">        self.__cond = Condition(Lock())</div><div class="line">        self.__flag = <span class="keyword">False</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_reset_internal_locks</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># private!  called by Thread._reset_internal_locks by _after_fork()</span></div><div class="line">        self.__cond.__init__()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isSet</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">&apos;Return true if and only if the internal flag is true.&apos;</span></div><div class="line">        <span class="keyword">return</span> self.__flag</div><div class="line"></div><div class="line">    is_set = isSet</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self)</span>:</span></div><div class="line">	<span class="string">&apos;&apos;&apos;</span></div><div class="line">	&#x8BBE;&#x7F6E;&#x5185;&#x90E8;&#x7684;flag&#x4E3A;true&#xFF0C;</div><div class="line">	&#x5E76;&#x4E14;&#x5524;&#x9192;&#x6240;&#x6709;&#x963B;&#x585E;&#x5728;&#x8BE5;&#x4E8B;&#x4EF6;&#x4E0A;&#x7684;&#x6240;&#x6709;&#x7EBF;&#x7A0B;</div><div class="line">	&apos;&apos;&apos;</div><div class="line">        self.__cond.acquire()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self.__flag = <span class="keyword">True</span></div><div class="line">            self.__cond.notify_all()</div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            self.__cond.release()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></div><div class="line">	<span class="string">&apos;&apos;&apos;</span></div><div class="line">	&#x6E05;&#x9664;&#x5185;&#x90E8;&#x6807;&#x8BB0;&#xFF0C;&#x53EA;&#x6709;Event&#x5BF9;&#x8C61;&#x53C8;&#x53EF;&#x4EE5;&#x518D;&#x6B21;&#x4F7F;&#x7528;&#x4E86;&#x3002;</div><div class="line">	&apos;&apos;&apos;</div><div class="line">        self.__cond.acquire()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self.__flag = <span class="keyword">False</span></div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            self.__cond.release()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self, timeout=None)</span>:</span></div><div class="line">	<span class="string">&apos;&apos;&apos;</span></div><div class="line">	&#x963B;&#x585E;&#x76F4;&#x5230;&#x5185;&#x90E8;&#x7684;flag&#x4E3A;True&#xFF0C;&#x6216;&#x8005;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x5230;&#x8FBE;&#x3002;</div><div class="line">	&apos;&apos;&apos;</div><div class="line">        self.__cond.acquire()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.__flag:</div><div class="line">                self.__cond.wait(timeout)</div><div class="line">            <span class="keyword">return</span> self.__flag</div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            self.__cond.release()</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="threading-Semaphore"><a href="#threading-Semaphore" class="headerlink" title="threading.Semaphore"></a>threading.Semaphore</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Semaphore</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">    <span class="string">&quot;&quot;&quot;A factory function that returns a new semaphore.</span></div><div class="line"></div><div class="line">    Semaphores manage a counter representing the number of release() calls minus</div><div class="line">    the number of acquire() calls, plus an initial value. The acquire() method</div><div class="line">    blocks if necessary until it can return without making the counter</div><div class="line">    negative. If not given, value defaults to 1.</div><div class="line"></div><div class="line">    &quot;&quot;&quot;</div><div class="line">    <span class="keyword">return</span> _Semaphore(*args, **kwargs)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_Semaphore</span><span class="params">(_Verbose)</span>:</span></div><div class="line">    <span class="string">&quot;&quot;&quot;Semaphores manage a counter representing the number of release() calls</span></div><div class="line">       minus the number of acquire() calls, plus an initial value. The acquire()</div><div class="line">       method blocks if necessary until it can return without making the counter</div><div class="line">       negative. If not given, value defaults to 1.</div><div class="line"></div><div class="line">    &quot;&quot;&quot;</div><div class="line"></div><div class="line">    <span class="comment"># After Tim Peters&apos; semaphore class, but not quite the same (no maximum)</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value=<span class="number">1</span>, verbose=None)</span>:</span></div><div class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span>:</div><div class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;semaphore initial value must be &gt;= 0&quot;</span>)</div><div class="line">        _Verbose.__init__(self, verbose)</div><div class="line">        self.__cond = Condition(Lock())</div><div class="line">        self.__value = value</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self, blocking=<span class="number">1</span>)</span>:</span></div><div class="line">        <span class="string">&quot;&quot;&quot;Acquire a semaphore, decrementing the internal counter by one.</span></div><div class="line"></div><div class="line">        When invoked without arguments: if the internal counter is larger than</div><div class="line">        zero on entry, decrement it by one and return immediately. If it is zero</div><div class="line">        on entry, block, waiting until some other thread has called release() to</div><div class="line">        make it larger than zero. This is done with proper interlocking so that</div><div class="line">        if multiple acquire() calls are blocked, release() will wake exactly one</div><div class="line">        of them up. The implementation may pick one at random, so the order in</div><div class="line">        which blocked threads are awakened should not be relied on. There is no</div><div class="line">        return value in this case.</div><div class="line"></div><div class="line">        When invoked with blocking set to true, do the same thing as when called</div><div class="line">        without arguments, and return true.</div><div class="line"></div><div class="line">        When invoked with blocking set to false, do not block. If a call without</div><div class="line">        an argument would block, return false immediately; otherwise, do the</div><div class="line">        same thing as when called without arguments, and return true.</div><div class="line"></div><div class="line">        &quot;&quot;&quot;</div><div class="line">        rc = <span class="keyword">False</span></div><div class="line">        <span class="keyword">with</span> self.__cond:</div><div class="line">            <span class="keyword">while</span> self.__value == <span class="number">0</span>:</div><div class="line">                <span class="keyword">if</span> <span class="keyword">not</span> blocking:</div><div class="line">                    <span class="keyword">break</span></div><div class="line">                <span class="keyword">if</span> __debug__:</div><div class="line">                    self._note(<span class="string">&quot;%s.acquire(%s): blocked waiting, value=%s&quot;</span>,</div><div class="line">                            self, blocking, self.__value)</div><div class="line">                self.__cond.wait()</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                self.__value = self.__value - <span class="number">1</span></div><div class="line">                <span class="keyword">if</span> __debug__:</div><div class="line">                    self._note(<span class="string">&quot;%s.acquire: success, value=%s&quot;</span>,</div><div class="line">                            self, self.__value)</div><div class="line">                rc = <span class="keyword">True</span></div><div class="line">        <span class="keyword">return</span> rc</div><div class="line"></div><div class="line">    __enter__ = acquire</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">&quot;&quot;&quot;Release a semaphore, incrementing the internal counter by one.</span></div><div class="line"></div><div class="line">        When the counter is zero on entry and another thread is waiting for it</div><div class="line">        to become larger than zero again, wake up that thread.</div><div class="line"></div><div class="line">        &quot;&quot;&quot;</div><div class="line">        <span class="keyword">with</span> self.__cond:</div><div class="line">            self.__value = self.__value + <span class="number">1</span></div><div class="line">            <span class="keyword">if</span> __debug__:</div><div class="line">                self._note(<span class="string">&quot;%s.release: success, value=%s&quot;</span>,</div><div class="line">                        self, self.__value)</div><div class="line">            self.__cond.notify()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, t, v, tb)</span>:</span></div><div class="line">        self.release()</div></pre></td></tr></table></figure>
<h2 id="threading-BoundedSemaphore"><a href="#threading-BoundedSemaphore" class="headerlink" title="threading.BoundedSemaphore"></a>threading.BoundedSemaphore</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">BoundedSemaphore</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">    <span class="string">&quot;&quot;&quot;A factory function that returns a new bounded semaphore.</span></div><div class="line"></div><div class="line">    A bounded semaphore checks to make sure its current value doesn&apos;t exceed its</div><div class="line">    initial value. If it does, ValueError is raised. In most situations</div><div class="line">    semaphores are used to guard resources with limited capacity.</div><div class="line"></div><div class="line">    If the semaphore is released too many times it&apos;s a sign of a bug. If not</div><div class="line">    given, value defaults to 1.</div><div class="line"></div><div class="line">    Like regular semaphores, bounded semaphores manage a counter representing</div><div class="line">    the number of release() calls minus the number of acquire() calls, plus an</div><div class="line">    initial value. The acquire() method blocks if necessary until it can return</div><div class="line">    without making the counter negative. If not given, value defaults to 1.</div><div class="line"></div><div class="line">    &quot;&quot;&quot;</div><div class="line">    <span class="keyword">return</span> _BoundedSemaphore(*args, **kwargs)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_BoundedSemaphore</span><span class="params">(_Semaphore)</span>:</span></div><div class="line">    <span class="string">&quot;&quot;&quot;A bounded semaphore checks to make sure its current value doesn&apos;t exceed</span></div><div class="line">       its initial value. If it does, ValueError is raised. In most situations</div><div class="line">       semaphores are used to guard resources with limited capacity.</div><div class="line">    &quot;&quot;&quot;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value=<span class="number">1</span>, verbose=None)</span>:</span></div><div class="line">        _Semaphore.__init__(self, value, verbose)</div><div class="line">        self._initial_value = value</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">&quot;&quot;&quot;Release a semaphore, incrementing the internal counter by one.</span></div><div class="line"></div><div class="line">        When the counter is zero on entry and another thread is waiting for it</div><div class="line">        to become larger than zero again, wake up that thread.</div><div class="line"></div><div class="line">        If the number of releases exceeds the number of acquires,</div><div class="line">        raise a ValueError.</div><div class="line"></div><div class="line">        &quot;&quot;&quot;</div><div class="line">        <span class="keyword">with</span> self._Semaphore__cond:</div><div class="line">            <span class="keyword">if</span> self._Semaphore__value &gt;= self._initial_value:</div><div class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;Semaphore released too many times&quot;</span>)</div><div class="line">            self._Semaphore__value += <span class="number">1</span></div><div class="line">            self._Semaphore__cond.notify()</div></pre></td></tr></table></figure>
<h2 id="threading-Timer"><a href="#threading-Timer" class="headerlink" title="threading.Timer"></a>threading.Timer</h2><p>&#x5B9A;&#x65F6;&#x5668;&#x5BF9;&#x8C61;&#x3002;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Timer</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">	<span class="string">&apos;&apos;&apos;</span></div><div class="line">	&#x5DE5;&#x5382;&#x65B9;&#x6CD5;</div><div class="line">	&apos;&apos;&apos;</div><div class="line">    <span class="keyword">return</span> _Timer(*args, **kwargs)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_Timer</span><span class="params">(Thread)</span>:</span></div><div class="line">    <span class="string">&quot;&quot;&quot;Call a function after a specified number of seconds:</span></div><div class="line"></div><div class="line">            t = Timer(30.0, f, args=[], kwargs={})</div><div class="line">            t.start()</div><div class="line">            t.cancel()     # stop the timer&apos;s action if it&apos;s still waiting</div><div class="line"></div><div class="line">    &quot;&quot;&quot;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, interval, function, args=[], kwargs={})</span>:</span></div><div class="line">        Thread.__init__(self)</div><div class="line">        self.interval = interval</div><div class="line">        self.function = function</div><div class="line">        self.args = args</div><div class="line">        self.kwargs = kwargs</div><div class="line">        self.finished = Event()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cancel</span><span class="params">(self)</span>:</span></div><div class="line">	<span class="comment">#&#x53D6;&#x6D88;&#x8BA1;&#x65F6;&#x5668;&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x8BA9;&#x8BA1;&#x65F6;&#x5668;&#x8D85;&#x65F6;&#x65F6;&#x4E0D;&#x8C03;&#x7528;&#x4F20;&#x8FDB;&#x6765;&#x7684;function&#x51FD;&#x6570;</span></div><div class="line">        self.finished.set()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">	<span class="comment">#&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x8BA9;Event&#x5BF9;&#x8C61;&#x5728;selfinterval&#x540E;&#x8D85;&#x65F6;</span></div><div class="line">        self.finished.wait(self.interval)</div><div class="line">	<span class="comment">#&#x5982;&#x679C;&#x8D85;&#x65F6;&#x4E4B;&#x540E;&#xFF0C;&#x4E14;&#x6CA1;&#x6709;&#x8C03;&#x7528;&#x8FC7;cancel&#x65B9;&#x6CD5;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x8C03;&#x7528;&#x4F20;&#x8FDB;&#x6765;&#x7684;function&#x51FD;&#x6570;</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.finished.is_set():</div><div class="line">            self.function(*self.args, **self.kwargs)</div><div class="line">        self.finished.set()</div></pre></td></tr></table></figure></p>
<p>&#x53C2;&#x8003;&#xFF1A;<br><a href="http://blog.csdn.net/zhanh1218/article/details/32131385" target="_blank" rel="external">Python&#x591A;&#x7EBF;&#x7A0B;&#xFF08;threading&#xFF09;&#x5B66;&#x4E60;&#x603B;&#x7ED3;</a></p>
</div></article><div class="tags"><a href="/tags/Python/">Python</a><a href="/tags/多线程/">多线程</a><a href="/tags/threading/">threading</a></div><div class="paginator"><a href="/2016/08/24/io-model/" class="prev"><i class="iconfont icon-left"></i><span> 上一页</span></a><a href="/2016/08/18/python-attributes-and-methods/" class="next"><span>下一页</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">(function() {
var d = document, s = d.createElement('script');

s.src = '//ahonn.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script></section><footer><div class="copyright"><p>&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">gzmviavia</span></p><p class="theme">Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div></body><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></html>